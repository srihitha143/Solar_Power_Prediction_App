# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1YSGOGRFk6GXYTd-yJy-fS7PvCY8xmGS3
"""

import streamlit as st
import pandas as pd
import xgboost as xgb
import numpy as np

# --- Configuration ---
st.set_page_config(
    page_title="Solar Power Prediction",
    layout="wide",
    initial_sidebar_state="expanded"
)

# --- Model Loading ---
@st.cache_resource
def load_model(filename):
    """Loads the trained XGBoost model from the specified file."""
    try:
        model = xgb.XGBRegressor()
        # Loads the model file created by train_model.py
        model.load_model(filename)
        return model
    except Exception as e:
        st.error(f"Error loading model: {e}. Please ensure 'solar_power_model.json' exists.")
        st.stop()

MODEL_FILE = 'solar_power_model.json'
model = load_model(MODEL_FILE)

# --- UI Header ---
st.title("☀️ Solar Power Generation Predictor")
st.markdown("Enter the environmental parameters to predict the **Power Generated** (in Joules).")

# --- Feature Input Layout ---
# Columns to organize the input fields
col1, col2, col3 = st.columns(3)

with col1:
    st.header("Sun & Sky")
    # distance-to-solar-noon: in radians (0 to ~0.86)
    dtsn = st.slider(
        'Distance to Solar Noon (radians)',
        min_value=0.0, max_value=0.9, value=0.4, step=0.01,
        help="Proximity to the sun's highest point. Closer to 0 means midday sun."
    )
    # sky-cover: on a five-step scale (0-4)
    sky_cover = st.select_slider(
        'Sky Cover (0-4 Scale)',
        options=[0, 1, 2, 3, 4], value=0,
        help="0: Clear skies, 4: Overcast."
    )
    # visibility: in miles (0-10)
    visibility = st.slider(
        'Visibility (miles)',
        min_value=0, max_value=10, value=10, step=1,
        help="Horizontal distance visible through the atmosphere."
    )

with col2:
    st.header("Atmospheric Conditions")
    # temperature: in degrees Celsius
    temp = st.number_input(
        'Temperature (°C)',
        min_value=-20.0, max_value=50.0, value=25.0, step=0.5,
        format="%.1f"
    )
    # humidity: percentage (0-100)
    humidity = st.slider(
        'Humidity (%)',
        min_value=0, max_value=100, value=60, step=1
    )
    # average-pressure-(period): in inches of mercury
    avg_pressure = st.number_input(
        'Average Pressure (inHg)',
        min_value=28.0, max_value=32.0, value=29.92, step=0.01,
        format="%.2f",
        help="Air pressure averaged over the period."
    )

with col3:
    st.header("Wind")
    # wind-direction: in degrees (0-360)
    wind_dir = st.slider(
        'Wind Direction (degrees)',
        min_value=0, max_value=360, value=90, step=1
    )
    # wind-speed: in meters per second
    wind_speed = st.number_input(
        'Wind Speed (m/s)',
        min_value=0.0, max_value=30.0, value=5.0, step=0.1,
        format="%.1f"
    )
    # average-wind-speed-(period): in knots
    avg_wind_speed = st.number_input(
        'Avg. Wind Speed (knots)',
        min_value=0.0, max_value=30.0, value=10.0, step=0.1,
        format="%.1f",
        help="Wind speed averaged over the period."
    )


# --- Prediction Button and Logic ---
st.markdown("---")
if st.button('Predict Power Generation', type='primary'):

    # 1. Collect inputs into a DataFrame for prediction
    input_data = {
        'distance-to-solar-noon': dtsn,
        'temperature': temp,
        'wind-direction': wind_dir,
        'wind-speed': wind_speed,
        'sky-cover': sky_cover,
        'visibility': visibility,
        'humidity': humidity,
        'average-wind-speed-(period)': avg_wind_speed,
        'average-pressure-(period)': avg_pressure
    }
    features_df = pd.DataFrame([input_data])

    # 2. Make Prediction
    try:
        prediction = model.predict(features_df)[0]
        # Ensure prediction is not negative
        prediction = max(0, prediction)

        # 3. Display Result
        st.success("✅ Prediction Successful!")
        st.metric(
            label="Predicted Power Generated",
            value=f"{prediction:,.0f} Joules",
            delta=f"Sky Cover: {sky_cover}"
        )

        st.balloons()

    except Exception as e:
        st.error(f"An error occurred during prediction: {e}")